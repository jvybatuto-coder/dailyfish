<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - DailyFish</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Expose csrf token in a meta tag for JS (Django will render the token) -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        body {
            /* Light red base with soft radiant highlights */
            background:
                radial-gradient(circle at top left, rgba(226, 59, 59, 0.18), transparent 55%),
                radial-gradient(circle at bottom right, rgba(226, 59, 59, 0.15), transparent 55%),
                #fff5f5;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        .header { background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        
        /* Remove focus outlines */
        #confirmModal:focus,
        #confirmModal *:focus,
        #confirmModal *:active,
        #confirmModal *:focus-visible {
            outline: none !important;
            box-shadow: none !important;
        }
        .header-content { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 2rem; }
        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #e23b3b;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .logo-text {
            font-size: 2rem;
            font-weight: 700;
            padding-left: 25px;
        }

        .logo img {
            position: absolute;
            left: -190px;
            top: 50%;
            transform: translateY(-50%);
            width: 250px;
            height: auto;
        }
        .header-title { color: #e23b3b; margin: 0; font-size: 1.8rem; }
        .nav { display: flex; align-items: center; gap: 0.75rem; }
        .nav a { background: #fff; color: #e23b3b; border: 2px solid #e23b3b; border-radius: 8px; padding: 0.5rem 0.9rem; text-decoration: none; font-weight: 600; transition: all 0.3s ease; }
        .nav a:hover { background: #fff !important; color: #c82333 !important; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(226,59,59,0.3); }
        main.container { margin-top: 100px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="{% url 'fish_list' %}" class="logo">
                <img src="{% static 'image/fish.png' %}" alt="DailyFish Logo">
                <span class="logo-text">DailyFish</span>
            </a>
            <nav class="nav" aria-label="Main navigation">
                <a href="{% url 'fish_list' %}">Shop Fish</a>
                <a href="{% url 'cart' %}" style="display: flex; align-items: center; gap: 0.5rem; position: relative; text-decoration: none; padding: 0.5rem 1rem; background: #fff; border: 2px solid #e23b3b; border-radius: 8px; transition: all 0.3s ease;">
                    <span>Cart</span>
                    <span style="position: relative;">
                        <span style="font-size: 1.2rem;">ðŸ›’</span>
                        {% if cart.get_total_items > 0 %}
                        <span class="cart-count" style="position: absolute; top: -12px; right: -12px; background-color: #e23b3b; color: white; border: 2px solid #fff; border-radius: 50%; min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; box-shadow: 0 2px 6px rgba(0,0,0,0.2); padding: 0 4px;">
                            {{ cart.get_total_items }}
                        </span>
                        {% endif %}
                    </span>
                </a>
                <a href="{% url 'order_history' %}">My Orders</a>
                <a href="{% url 'message_center' %}">Messages</a>
                <a href="{% url 'logout' %}">Logout</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="main-content">
            <h1 style="color: #e23b3b; margin-bottom: 2rem;">Shopping Cart</h1>

            <div style="max-width: 800px; margin: 0 auto;">
                <!-- Cart Items -->
                <div>
                    {% if cart_items %}
                        {% for item in cart_items %}
                            <div class="cart-item-card" style="background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    {% if item.fish.image %}
                                        <img src="{{ item.fish.image.url }}" alt="{{ item.fish.name }}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                                    {% else %}
                                        <div style="width: 80px; height: 80px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: #666;">
                                            No Image
                                        </div>
                                    {% endif %}

                                    <div style="flex: 1;">
                                        <h3 style="color: var(--old-mauve); margin-bottom: 0.5rem;">{{ item.fish.name }}</h3>
                                        <p style="color: #666; margin-bottom: 0.5rem;">â‚±{{ item.fish.price_per_kg|floatformat:2 }}/kg</p>

                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <label for="quantity-{{ item.id }}">Quantity (kg):</label>
                                            <input type="number" id="quantity-{{ item.id }}" value="{{ item.quantity_kg }}" min="0.1" step="0.1" style="width: 100px; padding: 0.5rem; border: 2px solid #e9ecef; border-radius: 8px;">

                                            <button type="button" data-item-id="{{ item.id }}" class="btn btn-secondary update-btn" style="padding: 0.5rem 1rem;">Update</button>
                                            <button type="button" data-item-id="{{ item.id }}" class="btn btn-danger remove-btn" style="padding: 0.5rem 1rem; background: #dc3545;">Remove</button>
                                        </div>
                                    </div>

                                    <div style="text-align: right;">
                                        <p style="font-weight: 600; color: var(--old-mauve); font-size: 1.1rem;">â‚±{{ item.total_price|floatformat:2 }}</p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <h3>Your cart is empty</h3>
                            <p>Add some fish to get started!</p>
                            <a href="{% url 'fish_list' %}" class="btn btn-primary">Shop Now</a>
                        </div>
                    {% endif %}
                </div>

                <!-- Order Summary -->
                <div style="background: var(--light-gray); padding: 2rem; border-radius: 12px; margin-top: 2rem;">
                    <h3 style="color: var(--old-mauve); margin-bottom: 1.5rem; text-align: center; font-size: 1.4rem;">Order Summary</h3>
                    
                    <div style="background: white; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; font-size: 1rem;">
                            <span style="color: #555;">Subtotal:</span>
                            <span style="font-weight: 500;">â‚±{{ cart.get_total_amount|floatformat:2|default:'0.00' }}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; font-size: 1rem;">
                            <span style="color: #555;">Shipping Fee:</span>
                            <span style="font-weight: 500;">â‚±50.00</span>
                        </div>
                        <hr style="margin: 1.25rem 0; border: none; border-top: 1px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.3rem; color: var(--old-mauve);">
                            <span>Total:</span>
                            <span>â‚±{{ cart.get_total_with_shipping|floatformat:2|default:'0.00' }}</span>
                        </div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        {% if cart_items %}
                            <a href="{% url 'checkout' %}"
                               class="btn"
                               style="width: 100%; text-align: center; background:#e23b3b; color:white; border:2px solid #e23b3b; border-radius:8px; font-weight:600; padding:0.7rem 1.5rem; transition:all .3s ease; font-size: 1.05rem;"
                               onmouseover="this.style.backgroundColor='#c82333'; this.style.borderColor='#c82333'; this.style.transform='translateY(-2px)';"
                               onmouseout="this.style.backgroundColor='#e23b3b'; this.style.borderColor='#e23b3b'; this.style.transform='translateY(0)';"
                            >
                                Proceed to Checkout
                            </a>
                        {% else %}
                            <button class="btn btn-secondary" style="width: 100%; padding: 0.7rem 1.5rem; font-size: 1.05rem;" disabled>Cart is Empty</button>
                        {% endif %}

                        <a href="{% url 'fish_list' %}" 
                           class="btn" 
                           style="width: 100%; text-align: center; background:white; color:#e23b3b; border:2px solid #e23b3b; border-radius:8px; font-weight:600; padding:0.7rem 1.5rem; transition:all .3s ease; font-size: 1.05rem;"
                           onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.transform='translateY(-2px)';"
                           onmouseout="this.style.backgroundColor='white'; this.style.transform='translateY(0)';"
                        >
                            Continue Shopping
                        </a>
                    </div>
                </div>
            </div>

            <div id="empty-state" class="empty-state" style="display:none; margin-top: 1rem;">
                <h3>Your cart is empty</h3>
                <p>Add some fresh fish to get started!</p>
                <a href="{% url 'fish_list' %}" class="btn btn-primary">Shop Now</a>
            </div>
        </div>
    </main>

    <!-- Confirmation Modal -->
    <div id="confirmModal" tabindex="-1" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: rgba(0, 0, 0, 0.5); outline: none; border: none; box-shadow: none;">
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: white; padding: 2rem; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); outline: none; border: none; font-family: 'Inter', sans-serif;">
            <h3 style="color: #000; margin-bottom: 1.5rem; text-align: center; font-size: 1.1rem; font-weight: 600; letter-spacing: 0.3px;">Remove Item</h3>
            <p style="text-align: center; margin-bottom: 2rem; color: #000; line-height: 1.5; font-weight: 400; font-size: 0.95rem;">Are you sure you want to remove this item from your cart?</p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button id="confirmRemoveBtn" style="background: #e23b3b; color: #ffffff; border: none; padding: 0.75rem 1.75rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(210, 37, 37, 0.2);">
                    Remove
                </button>
                <button id="cancelRemoveBtn" style="background: #f8f9fa; color: #333; border: 1px solid #e0e0e0; padding: 0.75rem 1.75rem; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    
    <script>
        // Read CSRF token from cookie (works with Django's default setup)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        function handleJsonResponse(response) {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        }

        // Delegate click handlers for update and remove buttons
        document.addEventListener('click', function (e) {
            const updateBtn = e.target.closest('.update-btn');
            const removeBtn = e.target.closest('.remove-btn');

            if (updateBtn) {
                const itemId = updateBtn.dataset.itemId;
                const qtyInput = document.getElementById(`quantity-${itemId}`);
                const q = Number(qtyInput && qtyInput.value ? qtyInput.value : '0');
                if (!q || q <= 0) {
                    alert('Please enter a valid quantity');
                    return;
                }

                const params = new URLSearchParams();
                params.append('quantity', q);

                fetch(`/cart/update/${itemId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: params.toString()
                })
                .then(handleJsonResponse)
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message || 'Failed to update item');
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Error updating cart item');
                });

                return;
            }

            if (removeBtn) {
                const itemId = removeBtn.dataset.itemId;
                const modal = document.getElementById('confirmModal');
                const confirmBtn = document.getElementById('confirmRemoveBtn');
                const cancelBtn = document.getElementById('cancelRemoveBtn');
                
                // Store the item ID in the confirm button for later use
                confirmBtn.dataset.itemId = itemId;
                
                // Show the modal
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden'; // Prevent scrolling
                
                // Function to remove event listeners and hide modal
                const cleanup = () => {
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                    modal.style.display = 'none';
                    document.body.style.overflow = ''; // Re-enable scrolling
                };
                
                // Add hover effects
                confirmBtn.onmouseenter = () => {
                    confirmBtn.style.background = '#c82333'; // Darker red on hover
                    confirmBtn.style.transform = 'translateY(-2px)';
                    confirmBtn.style.boxShadow = '0 4px 12px rgba(210, 37, 37, 0.3)';
                };
                confirmBtn.onmouseleave = () => {
                    confirmBtn.style.background = '#e23b3b'; // Original red color
                    confirmBtn.style.transform = 'translateY(0)';
                    confirmBtn.style.boxShadow = '0 2px 8px rgba(210, 37, 37, 0.2)';
                };
                
                cancelBtn.onmouseenter = () => {
                    cancelBtn.style.background = '#f0f0f0';
                    cancelBtn.style.transform = 'translateY(-2px)';
                    cancelBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                };
                cancelBtn.onmouseleave = () => {
                    cancelBtn.style.background = '#f8f9fa';
                    cancelBtn.style.transform = 'translateY(0)';
                    cancelBtn.style.boxShadow = 'none';
                };
                
                // Handle confirm button click
                const confirmHandler = () => {
                    const itemId = confirmBtn.dataset.itemId;
                    fetch(`/cart/remove/${itemId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(handleJsonResponse)
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert(data.message || 'Failed to remove item');
                            cleanup();
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Error removing item from cart');
                        cleanup();
                    });
                };
                
                // Handle cancel button click
                const cancelHandler = () => {
                    cleanup();
                };
                
                // Add event listeners
                confirmBtn.addEventListener('click', confirmHandler);
                cancelBtn.addEventListener('click', cancelHandler);
            }
        });

        // Guarded toggle for top nav Me dropdown
        (function(){
            const btn = document.getElementById('me-nav-link');
            const menu = document.getElementById('me-nav-menu');
            if (btn && menu) {
                btn.addEventListener('click', function(e){
                    e.stopPropagation();
                    const show = menu.style.display !== 'block';
                    menu.style.display = show ? 'block' : 'none';
                    btn.setAttribute('aria-expanded', show ? 'true' : 'false');
                });
                document.addEventListener('click', function(){
                    menu.style.display = 'none';
                    btn.setAttribute('aria-expanded', 'false');
                });
            }
        })();
    </script>
</body>
</html>
