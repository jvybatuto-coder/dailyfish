<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fish Catalog - DailyFish</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        body {
            /* Light red base with soft radiant highlights */
            background:
                radial-gradient(circle at top left, rgba(226, 59, 59, 0.18), transparent 55%),
                radial-gradient(circle at bottom right, rgba(226, 59, 59, 0.15), transparent 55%),
                #fff5f5;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        .header { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .header-content { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 2rem; }
        
        /* ---------- NOTIFICATION ---------- */
        .notification-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99999;
            width: auto;
            max-width: 90%;
            pointer-events: none;
        }

        .notification {
            padding: 1rem 2rem;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideInDown 0.3s ease-out;
            margin-bottom: 0.5rem;
            border-radius: 10px;
            display: inline-block;
            color: #111; /* black text for readability */
            background: #d4edda; /* default to success-like */
            pointer-events: auto;
            min-width: 300px;
        }

        .notification.success { background: #d4edda; }
        .notification.error { background: #f8d7da; }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #e23b3b;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .logo-text {
            font-size: 2rem;
            font-weight: 700;
            padding-left: 60px;
        }

        .logo img {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: auto;
        }
        .header-title { color: #e23b3b; margin: 0; font-size: 1.8rem; }
        .nav { display: flex; align-items: center; gap: 0.75rem; }
        .nav a { background: white; color: #e23b3b; border: 2px solid #e23b3b; border-radius: 8px; padding: 0.5rem 0.9rem; text-decoration: none; font-weight: 600; transition: all 0.3s ease; }
        .nav a:hover { background: white !important; color: #c82333 !important; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(226,59,59,0.3); }
        main.container { margin-top: 100px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="{% url 'fish_list' %}" class="logo">
                <img src="{% static 'image/fish.png' %}" alt="DailyFish Logo">
                <span class="logo-text">DailyFish</span>
            </a>
            <nav class="nav" aria-label="Main navigation">
                <a href="{% url 'fish_list' %}">Shop Fish</a>
                <a href="{% url 'cart' %}" style="display:flex; align-items:center; gap:.4rem;">
                    <span>Cart</span>
                    <span style="font-size:1.1rem;">üõí</span>
                    <span class="cart-count" id="cart-count" style="margin-left:.25rem;">0</span>
                </a>
                <a href="{% url 'order_history' %}">My Orders</a>
                <a href="{% url 'message_center' %}" style="display:flex; align-items:center; gap:.4rem;">
                    <span>Messages</span>
                    <span style="font-size:1.1rem;"></span>
                </a>
                {% if user.is_authenticated %}
                    <a href="{% url 'logout' %}">Logout</a>
                {% else %}
                    <a href="{% url 'login' %}">Login</a>
                {% endif %}
            </nav>
        </div>
    </header>

    <!-- Django Messages Display -->
    {% if messages %}
        <div class="notification-container">
            {% for message in messages %}
                <div class="notification {% if message.tags == 'error' %}error{% else %}success{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <main class="container">
        <div class="main-content">
            <h1 style="color: #e23b3b; margin-bottom: 2rem;">Fresh Fish Catalog</h1>

            <!-- Hidden CSRF token for AJAX requests -->
            {% csrf_token %}

            <!-- Search and Filter Bar -->
            <div class="search-bar">
                <form method="GET" style="display: flex; gap: 1rem; width: 100%; align-items: center;">
                    <input type="text" name="search" value="{{ search_query }}" placeholder="Search fish..." class="search-input" style="flex: 2;">
                    <select name="category" class="filter-select" style="flex: 1;">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary">Filter</button>
                </form>
            </div>

            <!-- Results Count -->
            {% if fish_items %}
                <p style="color: var(--muted); margin-bottom: 1rem;">
                    Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} fish
                </p>
            {% endif %}

            <!-- Fish Grid -->
            {% if fish_items %}
                <div class="product-grid">
                    {% for fish in fish_items %}
                        <div class="product-card">
                            <img src="{{ fish.display_image }}" alt="{{ fish.name }}" class="product-image">
                            <div class="product-info">
                                <h3 class="product-name">{{ fish.name }}</h3>
                                <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 0.5rem;">{{ fish.category.name }}</p>
                                <p class="product-price">‚Ç±{{ fish.price_per_kg }}/kg</p>
                                <div class="product-meta" style="margin: 0.5rem 0;">
                                    {% with rating=fish.average_rating %}
                                    {% if rating.count > 0 %}
                                        <div class="rating-display" style="display: flex; align-items: center; gap: 0.25rem; margin-bottom: 0.25rem;">
                                            <div class="stars" style="color: #ffc107; font-size: 1rem;">
                                                {% for i in '12345'|make_list %}
                                                    {% if forloop.counter <= rating.average|floatformat:0|add:0 %}
                                                        ‚òÖ
                                                    {% else %}
                                                        ‚òÜ
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                            <span style="font-size: 0.8rem; color: #6c757d;">
                                                {{ rating.average }} ({{ rating.count }} review{{ rating.count|pluralize }})
                                            </span>
                                        </div>
                                    {% else %}
                                        <div class="rating-display" style="margin-bottom: 0.25rem;">
                                            <span style="font-size: 0.8rem; color: #6c757d;">No reviews yet</span>
                                        </div>
                                    {% endif %}
                                    {% endwith %}
                                    
                                    <div class="sold-count" style="font-size: 0.85rem; color: #28a745; font-weight: 500;">
                                        {% if fish.total_sold > 0 %}
                                            Sold: {{ fish.total_sold|floatformat:0 }} kg
                                        {% else %}
                                            New
                                        {% endif %}
                                    </div>
                                </div>
                                <p class="product-stock {{ fish.stock_status }}" style="margin-top: 0.5rem;">
                                    {% if fish.stock_status == 'out' %}
                                        Out of Stock
                                    {% elif fish.stock_status == 'low' %}
                                        Only {{ fish.stock_kg|floatformat:2 }}kg left
                                    {% else %}
                                        {{ fish.stock_kg|floatformat:2 }}kg available
                                    {% endif %}
                                </p>
                                <div class="product-buttons">
                                    <a href="{% url 'fish_detail' fish.id %}" class="btn btn-secondary">View Details</a>
                                    {% if fish.stock_status != 'out' %}
                                        <button 
                                            data-fish-id="{{ fish.id }}" 
                                            data-fish-name="{{ fish.name|escape }}" 
                                            data-price="{{ fish.price_per_kg }}" 
                                            data-image="{{ fish.display_image|escape }}" 
                                            data-stock="{{ fish.stock_kg }}" 
                                            class="btn btn-primary add-to-cart">Add to Cart</button>
                                        <button 
                                            data-fish-id="{{ fish.id }}" 
                                            data-fish-name="{{ fish.name|escape }}" 
                                            data-price="{{ fish.price_per_kg }}" 
                                            data-image="{{ fish.display_image|escape }}" 
                                            data-stock="{{ fish.stock_kg }}" 
                                            class="btn btn-order order-now">
                                            Order Now
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                    <div style="display: flex; justify-content: center; margin-top: 3rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            {% if page_obj.has_previous %}
                                <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" class="btn btn-secondary">Previous</a>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <span class="btn btn-primary">{{ num }}</span>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" class="btn btn-secondary">{{ num }}</a>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}" class="btn btn-secondary">Next</a>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <h3>No fish found</h3>
                    <p>Try adjusting your search or filter criteria.</p>
                    <a href="{% url 'fish_list' %}" class="btn btn-primary">View All Fish</a>
                </div>
            {% endif %}
        </div>
    </main>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Add to Cart Modal -->
    <div id="addcart-modal" class="modal-overlay" style="display: none;">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="addcart-title">
            <div class="modal-header">
                <h2 class="modal-title" id="addcart-title">Add to Cart</h2>
                <button class="modal-close" type="button" onclick="closeAddCartModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem; align-items: center;">
                    <img id="addcart-image" src="" alt="Selected fish" style="width: 120px; height: 120px; object-fit: cover; border-radius: 10px; background:#f3f4f6;">
                    <div>
                        <div id="addcart-name" style="font-weight: 700; font-size: 1.1rem; color: var(--dark-gray);"></div>
                        <div id="addcart-price" style="margin-top: .25rem; font-weight: 700; font-size: 1.2rem; color: #000000;"></div>
                        <div id="addcart-stock" style="margin-top: .25rem; color: var(--muted);"></div>
                    </div>
                </div>

                <div style="margin-top: 1rem;">
                    <label for="addcart-qty" style="display:block; font-weight:600; margin-bottom:.5rem;">Quantity (kg)</label>
                    <div class="quantity-controls">
                        <button type="button" class="quantity-btn" aria-label="Decrease" onclick="changeAddCartQty(-0.1)">-</button>
                        <input id="addcart-qty" class="quantity-input" type="number" min="0.1" step="0.1" value="1">
                        <button type="button" class="quantity-btn" aria-label="Increase" onclick="changeAddCartQty(0.1)">+</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display:flex; gap:.5rem;">
                <button id="addcart-submit" type="button" class="btn btn-primary" style="width:100%; font-size:1.05rem;">Add to Cart</button>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="order-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Order Now</h2>
                <button class="modal-close" onclick="closeOrderModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="order-item" class="order-item">
                    <img id="order-item-image" src="" alt="" class="order-item-image">
                    <div class="order-item-details">
                        <h3 id="order-item-name" class="order-item-name"></h3>
                        <p id="order-item-price" class="order-item-price"></p>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="decreaseQuantity()">-</button>
                            <input type="number" id="quantity-input" class="quantity-input" value="1" min="0.1" step="0.1" onchange="updateTotal()">
                            <button class="quantity-btn" onclick="increaseQuantity()">+</button>
                            <span style="margin-left: 0.5rem; color: var(--muted);">kg</span>
                        </div>
                    </div>
                </div>

                <div id="total-price" class="total-price">Total: ‚Ç±0.00</div>
                <div id="shipping-fee" class="total-price" style="margin-top:.25rem; color:#666; font-size:.95rem;">Shipping: ‚Ç±50.00</div>
                <div id="grand-total" class="total-price" style="margin-top:.25rem; font-weight:700;">Grand Total: ‚Ç±0.00</div>

                <div class="payment-methods">
                    <h4 style="margin-bottom: 1rem; color: var(--dark-gray);">Payment Method</h4>
                    <div class="payment-method" onclick="selectPaymentMethod('gcash', this)">
                        <input type="radio" name="payment" value="gcash" id="gcash">
                        <label for="gcash">GCash</label>
                    </div>
                    <div class="payment-method" onclick="selectPaymentMethod('cod', this)">
                        <input type="radio" name="payment" value="cod" id="cod">
                        <label for="cod">Cash on Delivery (COD)</label>
                    </div>
                </div>

                <div class="contact-section" style="margin-top:1rem;">
                    <h4 style="margin-bottom:0.5rem; color:var(--dark-gray)">Contact Number</h4>
                    <input type="tel" id="contact-number-input" placeholder="e.g. 09171234567" pattern="^[0-9]{10,15}$" style="padding:0.6rem; border:1px solid #e5e7eb; border-radius:8px; width:100%;" oninput="updatePlaceOrderButton()">
                    <small style="color: var(--muted);">Digits only, 10‚Äì15 characters.</small>
                </div>

                <div class="notes-section" style="margin-top:1rem;">
                    <h4 style="margin-bottom:0.5rem; color:var(--dark-gray)">Notes (Optional)</h4>
                    <textarea id="order-notes" rows="3" placeholder="Any special instructions for your order..." style="width:100%; padding:0.6rem; border:1px solid #e5e7eb; border-radius:8px;"></textarea>
                </div>

                <div class="address-section">
                    <h4 style="margin-bottom: 1rem; color: var(--dark-gray);">Delivery Address</h4>
                    <div id="address-display" class="address-display">
                        <p id="current-address">No address set. Please add your delivery address.</p>
                        <button class="address-edit-btn" onclick="toggleAddressForm()">Edit Address</button>
                    </div>
                    <div id="address-form" class="address-form">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <input type="text" id="municipality" placeholder="Municipality" class="form-input">
                            <input type="text" id="barangay" placeholder="Barangay" class="form-input">
                        </div>
                        <textarea id="address-details" placeholder="Street address, house number, landmarks..." class="form-input" style="height: 80px; resize: vertical;"></textarea>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="saveAddress()">Save Address</button>
                            <button class="btn btn-secondary" onclick="toggleAddressForm()">Cancel</button>
                        </div>
                    </div>
                </div>

                <div id="delivery-warning" class="delivery-warning" style="display: none;">
                    <strong>‚ö†Ô∏è Delivery Not Available</strong><br>
                    Sorry, delivery is not available in your area. You may message the seller for more information.
                </div>
            </div>
            <div class="modal-footer">
                <button id="place-order-btn" class="place-order-btn" onclick="placeOrder()" disabled>Place Order</button>
            </div>
        </div>
    </div>

    <script>
        // Profile dropdown functionality has been removed
        // CSRF helpers (Django-compatible)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function getCsrfToken() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta && meta.getAttribute('content')) return meta.getAttribute('content');
            const input = document.querySelector('[name=csrfmiddlewaretoken]');
            if (input && input.value) return input.value;
            return getCookie('csrftoken') || '';
        }

        // Global variables for order modal
        let currentOrderItem = null;
        let currentQuantity = 1;
        let currentPrice = 0;
        let selectedPaymentMethod = null;
        let maxStock = 0;

        // Deliverable areas - CONFIGURABLE BY SELLER
        const DELIVERABLE_AREAS = ['Naval', 'Almeria', 'Biliran'];

        // Notification system
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            // use classes for notification and type (e.g., 'notification success' or 'notification error')
            notification.className = 'notification ' + type;
            notification.textContent = message;
            container.appendChild(notification);

            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Order modal functions
        function openOrderModal(id, name, price, image, stock) {
            currentOrderItem = { id, name, price, image };
            currentPrice = parseFloat(price);
            maxStock = parseFloat(stock);
            currentQuantity = 1;

            // Update modal content
            document.getElementById('order-item-image').src = image;
            document.getElementById('order-item-image').alt = name;
            document.getElementById('order-item-name').textContent = name;
            // show price safely as text
            document.getElementById('order-item-price').textContent = '‚Ç±' + Number(price).toFixed(2) + '/kg';
            document.getElementById('quantity-input').value = 1;
            document.getElementById('quantity-input').max = stock;

            // Reset form and default to COD so the button isn't blocked by payment selection
            document.querySelectorAll('input[name="payment"]').forEach(radio => radio.checked = false);
            const codRadio = document.getElementById('cod');
            if (codRadio) codRadio.checked = true;
            selectedPaymentMethod = 'cod';
            updatePlaceOrderButton();

            // Load saved address
            loadSavedAddress();

            // Prefill saved contact number
            try {
                const savedNumber = localStorage.getItem('userContactNumber');
                if (savedNumber) {
                    const c = document.getElementById('contact-number-input');
                    if (c) c.value = savedNumber;
                }
            } catch (_) {}

            // Show modal
            document.getElementById('order-modal').style.display = 'flex';
            updateTotal();
        }

        function closeOrderModal() {
            document.getElementById('order-modal').style.display = 'none';
        }

        function increaseQuantity() {
            const input = document.getElementById('quantity-input');
            const current = parseFloat(input.value) || 0;
            if (current < maxStock) {
                input.value = Math.min(current + 0.1, maxStock).toFixed(1);
                updateTotal();
            }
        }

        function decreaseQuantity() {
            const input = document.getElementById('quantity-input');
            const current = parseFloat(input.value) || 0;
            if (current > 0.1) {
                input.value = Math.max(current - 0.1, 0.1).toFixed(1);
                updateTotal();
            }
        }

        const ORDER_SHIPPING_FEE = 50; // Match checkout shipping

        function updateTotal() {
            const quantity = parseFloat(document.getElementById('quantity-input').value) || 0;
            const total = quantity * currentPrice;
            document.getElementById('total-price').textContent = `Total: ‚Ç±${total.toFixed(2)}`;
            const shipping = ORDER_SHIPPING_FEE;
            const grand = total + shipping;
            const shipEl = document.getElementById('shipping-fee');
            const grandEl = document.getElementById('grand-total');
            if (shipEl) shipEl.textContent = `Shipping: ‚Ç±${shipping.toFixed(2)}`;
            if (grandEl) grandEl.textContent = `Grand Total: ‚Ç±${grand.toFixed(2)}`;
            currentQuantity = quantity;
            updatePlaceOrderButton();
        }

        function selectPaymentMethod(method, el) {
            selectedPaymentMethod = method;
            document.querySelectorAll('.payment-method').forEach(e => e.classList.remove('selected'));
            if (el) el.classList.add('selected');
            updatePlaceOrderButton();
        }

        function isValidContactNumber(v){
            return /^\d{10,15}$/.test(String(v||'').trim());
        }

        function updatePlaceOrderButton() {
            const addressTextEl = document.getElementById('current-address');
            const hasAddress = addressTextEl && addressTextEl.textContent && !addressTextEl.textContent.includes('No address set');
            const contactEl = document.getElementById('contact-number-input');
            const hasValidContact = contactEl && isValidContactNumber(contactEl.value);
            const button = document.getElementById('place-order-btn');

            if (selectedPaymentMethod && hasAddress && hasValidContact && currentQuantity > 0) {
                button.disabled = false;
            } else {
                button.disabled = true;
            }
        }

        // Address management
        function loadSavedAddress() {
            const savedAddress = localStorage.getItem('userAddress');
            if (savedAddress) {
                const address = JSON.parse(savedAddress);
                const addressText = address.municipality + ', ' + address.barangay + (address.details ? ', ' + address.details : '');
                document.getElementById('current-address').textContent = addressText;
                checkDeliveryAvailability(address.municipality);
            } else {
                document.getElementById('current-address').textContent = 'No address set. Please add your delivery address.';
                document.getElementById('delivery-warning').style.display = 'none';
            }
            updatePlaceOrderButton();
        }

        function toggleAddressForm() {
            const form = document.getElementById('address-form');
            form.classList.toggle('show');

            if (form.classList.contains('show')) {
                // Load current address into form
                const savedAddress = localStorage.getItem('userAddress');
                if (savedAddress) {
                    const address = JSON.parse(savedAddress);
                    document.getElementById('municipality').value = address.municipality || '';
                    document.getElementById('barangay').value = address.barangay || '';
                    document.getElementById('address-details').value = address.details || '';
                }
            }
        }

        function saveAddress() {
            const municipality = document.getElementById('municipality').value.trim();
            const barangay = document.getElementById('barangay').value.trim();
            const details = document.getElementById('address-details').value.trim();

            if (!municipality || !barangay) {
                showNotification('Please fill in municipality and barangay', 'error');
                return;
            }

            const address = { municipality, barangay, details };
            localStorage.setItem('userAddress', JSON.stringify(address));

            const addressText = municipality + ', ' + barangay + (details ? ', ' + details : '');
            document.getElementById('current-address').textContent = addressText;

            checkDeliveryAvailability(municipality);
            toggleAddressForm();
            showNotification('Address saved successfully!', 'success');
        }

        function checkDeliveryAvailability(municipality) {
            const warning = document.getElementById('delivery-warning');
            const isDeliverable = DELIVERABLE_AREAS.some(area => 
                municipality.toLowerCase().includes(area.toLowerCase())
            );

            if (!isDeliverable) {
                warning.style.display = 'block';
                document.getElementById('place-order-btn').disabled = true;
            } else {
                warning.style.display = 'none';
                updatePlaceOrderButton();
            }
        }

        function placeOrder() {
            const btn = document.getElementById('place-order-btn');
            if (btn) { btn.disabled = true; btn.textContent = 'Placing...'; }
            if (!currentOrderItem || !selectedPaymentMethod || currentQuantity <= 0) {
                showNotification('Please complete all order details', 'error');
                if (btn) { btn.disabled = false; btn.textContent = 'Place Order'; }
                return;
            }

            const saved = localStorage.getItem('userAddress');
            if (!saved) {
                showNotification('Please set your delivery address', 'error');
                return;
            }

            const address = JSON.parse(saved || '{}');
            const isDeliverable = DELIVERABLE_AREAS.some(area => (address.municipality || '').toLowerCase().includes(area.toLowerCase()));
            if (!isDeliverable) {
                showNotification('Delivery is not available in your area', 'error');
                if (btn) { btn.disabled = false; btn.textContent = 'Place Order'; }
                return;
            }
            const contactEl = document.getElementById('contact-number-input');
            const contact = contactEl ? String(contactEl.value || '').trim() : '';
            if (!isValidContactNumber(contact)) {
                showNotification('Please enter a valid contact number (digits only, 10‚Äì15 characters).', 'error');
                if (btn) { btn.disabled = false; btn.textContent = 'Place Order'; }
                return;
            }

            const addressSnapshot = `${address.municipality || ''}${address.barangay ? ', ' + address.barangay : ''}${address.details ? ', ' + address.details : ''}`.trim();
            const notes = (document.getElementById('order-notes')?.value || '').trim();

            const params = new URLSearchParams();
            params.append('fish_id', currentOrderItem.id);
            params.append('quantity', String(currentQuantity));
            params.append('payment_method', selectedPaymentMethod);
            params.append('address', addressSnapshot);
            params.append('contact_number', contact);
            params.append('notes', notes);

            fetch('{% url "order_now" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                    'X-CSRFToken': getCsrfToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: params.toString()
            })
            .then(async res => {
                const ct = res.headers.get('content-type') || '';
                if (!ct.includes('application/json')) {
                    window.location.href = '/login/?next=' + encodeURIComponent(window.location.pathname);
                    return Promise.reject(new Error('Not JSON response'));
                }
                const data = await res.json().catch(() => null);
                if (!res.ok || !data) throw new Error(data && data.message ? data.message : 'Order failed');
                return data;
            })
            .then(data => {
                showNotification(data.message || 'Order placed successfully', 'success');
                // Persist contact number for future orders
                try {
                    const c = document.getElementById('contact-number-input');
                    if (c && c.value) localStorage.setItem('userContactNumber', String(c.value).trim());
                } catch (_) {}
                
                // Debug: Log the response data
                console.log('Order response:', data);
                
                // Close modal first
                closeOrderModal();
                
                // Redirect after a short delay to allow notification to show
                setTimeout(() => {
                    if (data.redirect_url) {
                        console.log('Redirecting to:', data.redirect_url);
                        window.location.href = data.redirect_url;
                    } else if (data.order_id) {
                        const redirectUrl = `/orders/${data.order_id}/`;
                        console.log('Redirecting to order ID:', redirectUrl);
                        window.location.href = redirectUrl;
                    } else {
                        console.log('No redirect info found, reloading page');
                        window.location.reload();
                    }
                }, 1500); // 1.5 second delay
            })
            .catch(err => {
                showNotification(String(err && err.message ? err.message : 'Error placing order'), 'error');
            })
            .finally(() => {
                if (btn) { btn.disabled = false; btn.textContent = 'Place Order'; }
            });
        }

        // Add-to-Cart Modal logic
        let addCartFishId = null;
        function openAddCartModal(id, name, price, image, stock) {
            addCartFishId = id;
            const overlay = document.getElementById('addcart-modal');
            if (!overlay) return;
            document.getElementById('addcart-image').src = image || '';
            document.getElementById('addcart-name').textContent = name || '';
            document.getElementById('addcart-price').textContent = price ? `‚Ç±${price}/kg` : '';
            document.getElementById('addcart-stock').textContent = stock ? `${stock}kg available` : '';
            const qty = document.getElementById('addcart-qty');
            if (qty) qty.value = '1';
            overlay.style.display = 'flex';
        }

        function closeAddCartModal() {
            const overlay = document.getElementById('addcart-modal');
            if (overlay) overlay.style.display = 'none';
        }

        function changeAddCartQty(delta) {
            const input = document.getElementById('addcart-qty');
            if (!input) return;
            const step = parseFloat(input.step) || 0.1;
            let val = parseFloat(input.value || '0') + delta;
            val = Math.max(val, parseFloat(input.min) || step);
            // round to 1 decimal to avoid float issues
            val = Math.round(val * 10) / 10;
            input.value = String(val);
        }

        document.getElementById('addcart-submit')?.addEventListener('click', function() {
            const input = document.getElementById('addcart-qty');
            const q = Number(input && input.value ? input.value : '1');
            if (!addCartFishId) return;
            if (!q || q <= 0) {
                showNotification('Please enter a valid quantity', 'error');
                return;
            }
            const params = new URLSearchParams();
            params.append('quantity', q);
            fetch(`/cart/add/${addCartFishId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                    'X-CSRFToken': getCsrfToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: params.toString()
            })
            .then(async response => {
                const ct = response.headers.get('content-type') || '';
                if (!ct.includes('application/json')) {
                    window.location.href = '/login/?next=' + encodeURIComponent(window.location.pathname);
                    return Promise.reject('Not JSON response');
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    showNotification(data.message || 'Added to cart', 'success');
                    updateCartCount();
                    closeAddCartModal();
                } else {
                    showNotification((data && data.message) || 'Error adding to cart', 'error');
                }
            })
            .catch(error => {
                showNotification('Error adding to cart', 'error');
                console.error('Error:', error);
            });
        });

        function updateCartCount() {
            fetch('/cart/')
            .then(response => response.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const cartCountElement = tempDiv.querySelector('.cart-count');
                if (cartCountElement) {
                    document.getElementById('cart-count').textContent = cartCountElement.textContent;
                }
            })
            .catch(error => {
                console.error('Error updating cart count:', error);
            });
        }

        // Auto-refresh functionality for product updates
    // Render last product count from server-side into JS as a number
    let lastProductCount = parseInt('{{ fish_items|length|default:"0" }}', 10) || 0;
        let refreshInterval;

        // (No dropdown for Me; direct link to registration)

        function checkForProductUpdates() {
            fetch(window.location.href, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                // Create a temporary DOM element to parse the response
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                // Count current products in the response
                const productCards = tempDiv.querySelectorAll('.product-card');
                const currentProductCount = productCards.length;

                // If product count changed, reload the page
                if (currentProductCount !== lastProductCount) {
                    lastProductCount = currentProductCount;
                    window.location.reload();
                }
            })
            .catch(error => {
                console.log('Auto-refresh check failed:', error);
            });
        }

        // Initialize cart count and auto-refresh on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-hide Django messages after 5 seconds
            const djangoMessages = document.querySelectorAll('.notification');
            djangoMessages.forEach(function(message) {
                setTimeout(() => {
                    message.style.opacity = '0';
                    setTimeout(() => {
                        message.remove();
                    }, 300);
                }, 5000);
            });

            updateCartCount();

            // Start auto-refresh every 10 seconds
            refreshInterval = setInterval(checkForProductUpdates, 10000);
            
            // Attach event listeners to dynamically added buttons
            document.querySelectorAll('.add-to-cart').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-fish-id');
                    const name = this.getAttribute('data-fish-name');
                    const price = this.getAttribute('data-price');
                    const image = this.getAttribute('data-image');
                    const stock = this.getAttribute('data-stock');
                    openAddCartModal(id, name, price, image, stock);
                });
            });

            document.querySelectorAll('.order-now').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-fish-id');
                    const name = this.getAttribute('data-fish-name');
                    const price = this.getAttribute('data-price');
                    const image = this.getAttribute('data-image');
                    const stock = this.getAttribute('data-stock');
                    openOrderModal(id, name, price, image, stock);
                });
            });

            // Keep selectedPaymentMethod in sync if user clicks radio inputs directly
            document.querySelectorAll('input[name="payment"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        selectedPaymentMethod = this.value;
                        updatePlaceOrderButton();
                    }
                });
            });
        });

        // Stop auto-refresh when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
            } else {
                // Restart auto-refresh when page becomes visible
                refreshInterval = setInterval(checkForProductUpdates, 10000);
            }
        });

        // Close Order modal when clicking outside
        document.getElementById('order-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeOrderModal();
            }
        });

        // Close Add-to-Cart modal when clicking outside
        document.getElementById('addcart-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddCartModal();
            }
        });
    </script>
</body>
</html>
