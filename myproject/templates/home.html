{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DailyFish - Fresh Fish Marketplace</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            /* Light red base with soft radiant highlights */
            background:
                radial-gradient(circle at top left, rgba(226, 59, 59, 0.18), transparent 55%),
                radial-gradient(circle at bottom right, rgba(226, 59, 59, 0.15), transparent 55%),
                #fff5f5;
            font-family: 'Inter', sans-serif; 
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        .header { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-title { color: #e23b3b; margin: 0; font-size: 1.8rem; }
        .nav a:hover {
            background: white !important;
            color: #c82333 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(226, 59, 59, 0.3);
        }
    </style>
</head>
<body>
    <header class="header" style="position: fixed; top: 0; left: 0; right: 0; z-index: 1000;">
        <div class="header-content" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 2rem;">
            <a href="{% url 'fish_list' %}" class="logo" style="display: flex; align-items: center; text-decoration: none; color: #e23b3b; transition: all 0.3s ease; position: relative;">
                <img src="{% static 'image/fish.png' %}" alt="DailyFish Logo" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 50px; height: auto;">
                <span class="logo-text" style="font-size: 2rem; font-weight: 700; padding-left: 60px;">DailyFish</span>
            </a>
            <nav class="nav" style="display: flex; align-items: center; gap: 0.75rem;">
                <a href="{% url 'fish_list' %}" style="padding: .5rem .9rem; background: white; color: #e23b3b; border: 2px solid #e23b3b; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease;">
                    Shop Fish
                </a>
                <a href="{% url 'cart' %}" style="display: flex; align-items: center; gap: .4rem; padding: .5rem .9rem; background: white; color: #e23b3b; border: 2px solid #e23b3b; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease;">
                    <span>Cart</span>
                    <span style="font-size: 1.1rem;">üõí</span>
                </a>
                <a href="{% url 'order_history' %}" style="padding: .5rem .9rem; background: white; color: #e23b3b; border: 2px solid #e23b3b; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease;">
                    My Orders
                </a>
                <a href="{% url 'message_center' %}" style="padding: .5rem .9rem; background: white; color: #e23b3b; border: 2px solid #e23b3b; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease;">
                    Messages
                </a>
                <a href="{% url 'logout' %}" style="padding: .5rem .9rem; background: white; color: #e23b3b; border: 2px solid #e23b3b; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s ease;">
                    Logout
                </a>
            </nav>
        </div>
    </header>
    

    <main class="container" style="margin-top: 100px;">
        <div class="main-content">
            <div style="text-align: center; margin-bottom: 3rem;">
                <h1 style="font-size: 3rem; color: var(--old-mauve); margin-bottom: 1rem;">Welcome to DailyFish</h1>
                <p style="font-size: 1.2rem; color: var(--muted); max-width: 600px; margin: 0 auto;">
                    Your trusted marketplace for fresh, high-quality fish. Browse our selection of premium fish varieties and place your order today!
                </p>
            </div>


            {% if categories %}
            <section style="margin-bottom: 3rem;">
                <h2 style="text-align: center; margin-bottom: 2rem; color: var(--old-mauve);">Categories</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    {% for category in categories %}
                    <div style="background: var(--white); padding: 2rem; border-radius: 12px; text-align: center; box-shadow: var(--shadow);">
                        <h3 style="color: var(--old-mauve); margin-bottom: 0.5rem;">{{ category.name }}</h3>
                        <p style="color: var(--muted); font-size: 0.9rem;">{{ category.description|truncatewords:10 }}</p>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <div style="text-align: center; margin-top: 3rem;">
                <h2 style="color: var(--old-mauve); margin-bottom: 1rem;">Ready to Shop?</h2>
                <p style="color: var(--muted); margin-bottom: 2rem;">Browse our full selection of fresh fish</p>
                <a href="{% url 'fish_list' %}" class="btn btn-primary" style="font-size: 1.1rem; padding: 1rem 2rem;">Shop Now</a>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p></p>
    </footer>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Order Modal -->
    <div id="order-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Order Now</h2>
                <button class="modal-close" onclick="closeOrderModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="order-item" class="order-item">
                    <img id="order-item-image" src="" alt="" class="order-item-image">
                    <div class="order-item-details">
                        <h3 id="order-item-name" class="order-item-name"></h3>
                        <p id="order-item-price" class="order-item-price"></p>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="decreaseQuantity()">-</button>
                            <input type="number" id="quantity-input" class="quantity-input" value="1" min="0.1" step="0.1" onchange="updateTotal()">
                            <button class="quantity-btn" onclick="increaseQuantity()">+</button>
                            <span style="margin-left: 0.5rem; color: var(--muted);">kg</span>
                        </div>
                    </div>
                </div>
                
                <div id="total-price" class="total-price">Total: ‚Ç±0.00</div>
                
                <div class="payment-methods">
                    <h4 style="margin-bottom: 1rem; color: var(--dark-gray);">Payment Method</h4>
                    <div class="payment-method" onclick="selectPaymentMethod('gcash')">
                        <input type="radio" name="payment" value="gcash" id="gcash">
                        <label for="gcash">GCash</label>
                    </div>
                    <div class="payment-method" onclick="selectPaymentMethod('cod')">
                        <input type="radio" name="payment" value="cod" id="cod">
                        <label for="cod">Cash on Delivery (COD)</label>
                    </div>
                </div>
                
                <div class="address-section">
                    <h4 style="margin-bottom: 1rem; color: var(--dark-gray);">Delivery Address</h4>
                    <div id="address-display" class="address-display">
                        <p id="current-address">No address set. Please add your delivery address.</p>
                        <button class="address-edit-btn" onclick="toggleAddressForm()">Edit Address</button>
                    </div>
                    <div id="address-form" class="address-form">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <input type="text" id="municipality" placeholder="Municipality" class="form-input">
                            <input type="text" id="barangay" placeholder="Barangay" class="form-input">
                        </div>
                        <textarea id="address-details" placeholder="Street address, house number, landmarks..." class="form-input" style="height: 80px; resize: vertical;"></textarea>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="saveAddress()">Save Address</button>
                            <button class="btn btn-secondary" onclick="toggleAddressForm()">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <div id="delivery-warning" class="delivery-warning" style="display: none;">
                    <strong>‚ö†Ô∏è Delivery Not Available</strong><br>
                    Sorry, delivery is not available in your area. You may message the seller for more information.
                </div>
            </div>
            <div class="modal-footer">
                <button id="place-order-btn" class="place-order-btn" onclick="placeOrder()" disabled>Place Order</button>
            </div>
        </div>
    </div>

    <script>
        // (No dropdown for Me; direct link to registration)
        // Global variables for order modal
        let currentOrderItem = null;
        let currentQuantity = 1;
        let currentPrice = 0;
        let selectedPaymentMethod = null;
        let maxStock = 0;

        // Deliverable areas - CONFIGURABLE BY SELLER
        const DELIVERABLE_AREAS = ['Naval', 'Almeria', 'Biliran'];

        // Notification system
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Order modal functions
        function openOrderModal(id, name, price, image, stock) {
            currentOrderItem = { id, name, price, image };
            currentPrice = parseFloat(price);
            maxStock = parseFloat(stock);
            currentQuantity = 1;
            
            // Update modal content
            document.getElementById('order-item-image').src = image;
            document.getElementById('order-item-image').alt = name;
            document.getElementById('order-item-name').textContent = name;
            document.getElementById('order-item-price').textContent = `‚Ç±${price}/kg`;
            document.getElementById('quantity-input').value = 1;
            document.getElementById('quantity-input').max = stock;
            
            // Reset form
            document.querySelectorAll('input[name="payment"]').forEach(radio => radio.checked = false);
            selectedPaymentMethod = null;
            updatePlaceOrderButton();
            
            // Load saved address
            loadSavedAddress();
            
            // Show modal
            document.getElementById('order-modal').style.display = 'flex';
            updateTotal();
        }

        function closeOrderModal() {
            document.getElementById('order-modal').style.display = 'none';
        }

        function increaseQuantity() {
            const input = document.getElementById('quantity-input');
            const current = parseFloat(input.value) || 0;
            if (current < maxStock) {
                input.value = Math.min(current + 0.1, maxStock).toFixed(1);
                updateTotal();
            }
        }

        function decreaseQuantity() {
            const input = document.getElementById('quantity-input');
            const current = parseFloat(input.value) || 0;
            if (current > 0.1) {
                input.value = Math.max(current - 0.1, 0.1).toFixed(1);
                updateTotal();
            }
        }

        function updateTotal() {
            const quantity = parseFloat(document.getElementById('quantity-input').value) || 0;
            const total = quantity * currentPrice;
            document.getElementById('total-price').textContent = `Total: ‚Ç±${total.toFixed(2)}`;
            currentQuantity = quantity;
            updatePlaceOrderButton();
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            updatePlaceOrderButton();
        }

        function updatePlaceOrderButton() {
            const hasAddress = document.getElementById('current-address').textContent !== 'No address set. Please add your delivery address.';
            const button = document.getElementById('place-order-btn');
            
            if (selectedPaymentMethod && hasAddress && currentQuantity > 0) {
                button.disabled = false;
            } else {
                button.disabled = true;
            }
        }

        // Address management
        function loadSavedAddress() {
            const savedAddress = localStorage.getItem('userAddress');
            if (savedAddress) {
                const address = JSON.parse(savedAddress);
                const addressText = `${address.municipality}, ${address.barangay}${address.details ? ', ' + address.details : ''}`;
                document.getElementById('current-address').textContent = addressText;
                checkDeliveryAvailability(address.municipality);
            } else {
                document.getElementById('current-address').textContent = 'No address set. Please add your delivery address.';
                document.getElementById('delivery-warning').style.display = 'none';
            }
            updatePlaceOrderButton();
        }

        function toggleAddressForm() {
            const form = document.getElementById('address-form');
            form.classList.toggle('show');
            
            if (form.classList.contains('show')) {
                // Load current address into form
                const savedAddress = localStorage.getItem('userAddress');
                if (savedAddress) {
                    const address = JSON.parse(savedAddress);
                    document.getElementById('municipality').value = address.municipality || '';
                    document.getElementById('barangay').value = address.barangay || '';
                    document.getElementById('address-details').value = address.details || '';
                }
            }
        }

        function saveAddress() {
            const municipality = document.getElementById('municipality').value.trim();
            const barangay = document.getElementById('barangay').value.trim();
            const details = document.getElementById('address-details').value.trim();
            
            if (!municipality || !barangay) {
                showNotification('Please fill in municipality and barangay', 'error');
                return;
            }
            
            const address = { municipality, barangay, details };
            localStorage.setItem('userAddress', JSON.stringify(address));
            
            const addressText = `${municipality}, ${barangay}${details ? ', ' + details : ''}`;
            document.getElementById('current-address').textContent = addressText;
            
            checkDeliveryAvailability(municipality);
            toggleAddressForm();
            showNotification('Address saved successfully!', 'success');
        }

        function checkDeliveryAvailability(municipality) {
            const warning = document.getElementById('delivery-warning');
            const isDeliverable = DELIVERABLE_AREAS.some(area => 
                municipality.toLowerCase().includes(area.toLowerCase())
            );
            
            if (!isDeliverable) {
                warning.style.display = 'block';
                document.getElementById('place-order-btn').disabled = true;
            } else {
                warning.style.display = 'none';
                updatePlaceOrderButton();
            }
        }

        function placeOrder() {
            if (!currentOrderItem || !selectedPaymentMethod || currentQuantity <= 0) {
                showNotification('Please complete all order details', 'error');
                return;
            }
            
            const savedAddress = localStorage.getItem('userAddress');
            if (!savedAddress) {
                showNotification('Please set your delivery address', 'error');
                return;
            }
            
            const address = JSON.parse(savedAddress);
            const isDeliverable = DELIVERABLE_AREAS.some(area => 
                address.municipality.toLowerCase().includes(area.toLowerCase())
            );
            
            if (!isDeliverable) {
                showNotification('Delivery is not available in your area', 'error');
                return;
            }
            
            // Create order object
            const order = {
                id: Date.now(),
                fish: currentOrderItem,
                quantity: currentQuantity,
                totalPrice: currentQuantity * currentPrice,
                paymentMethod: selectedPaymentMethod,
                address: address,
                timestamp: new Date().toISOString()
            };
            
            // Save order to localStorage (in a real app, this would be sent to backend)
            const orders = JSON.parse(localStorage.getItem('userOrders') || '[]');
            orders.push(order);
            localStorage.setItem('userOrders', JSON.stringify(orders));
            
            // Show success notification
            showNotification('Your order has been successfully placed. Please wait while we prepare your order.', 'success');
            
            // Close modal
            closeOrderModal();
            
            // Update stock (simulate)
            // In a real app, this would be handled by the backend
            console.log('Order placed:', order);
        }

        // Cart functions
        function getCart(){ return JSON.parse(localStorage.getItem('cartItems') || '[]'); }
        function saveCart(items){ localStorage.setItem('cartItems', JSON.stringify(items)); }
        function lsAddToCart(id, name, price, image){
            const qty = prompt('Enter quantity in kg:', '1');
            const q = Number(qty);
            if (!q || q <= 0) return;
            const items = getCart();
            const idx = items.findIndex(i => i.id === id);
            if (idx >= 0) items[idx].quantity = Number((Number(items[idx].quantity) + q).toFixed(2));
            else items.push({ id, name, price: Number(price), image, quantity: Number(q.toFixed(2)) });
            saveCart(items);
            showNotification(`${name} added to cart!`, 'success');
        }

        // Close modal when clicking outside
        document.getElementById('order-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeOrderModal();
            }
        });
    </script>
</body>
</html>


