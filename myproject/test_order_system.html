<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Now System Test</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo"> DailyFish</a>
            <nav class="nav">
                <a href="#">Test Page</a>
                <a href="#">Cart <span id="cart-count">0</span></a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="main-content">
            <h1 style="color: var(--old-mauve); margin-bottom: 2rem;">Order Now System Test</h1>
            
            <div class="product-grid">
                <div class="product-card">
                    <img src="https://via.placeholder.com/300x200/4CAF50/FFFFFF?text=Fresh+Salmon" alt="Salmon" class="product-image">
                    <div class="product-info">
                        <h3 class="product-name">Fresh Salmon</h3>
                        <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 0.5rem;">Premium Fish</p>
                        <p class="product-price">₱450/kg</p>
                        <p class="product-stock">25kg available</p>
                        <div class="product-buttons">
                            <a href="#" class="btn btn-secondary">View Details</a>
                            <button onclick="lsAddToCart(1, 'Fresh Salmon', 450, 'https://via.placeholder.com/300x200/4CAF50/FFFFFF?text=Fresh+Salmon')" class="btn btn-primary">Add to Cart</button>
                            <button onclick="openOrderModal(1, 'Fresh Salmon', 450, 'https://via.placeholder.com/300x200/4CAF50/FFFFFF?text=Fresh+Salmon', 25)" class="btn btn-order">Order Now</button>
                        </div>
                    </div>
                </div>

                <div class="product-card">
                    <img src="https://via.placeholder.com/300x200/2196F3/FFFFFF?text=Tuna+Steak" alt="Tuna" class="product-image">
                    <div class="product-info">
                        <h3 class="product-name">Tuna Steak</h3>
                        <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 0.5rem;">Premium Fish</p>
                        <p class="product-price">₱380/kg</p>
                        <p class="product-stock">15kg available</p>
                        <div class="product-buttons">
                            <a href="#" class="btn btn-secondary">View Details</a>
                            <button onclick="lsAddToCart(2, 'Tuna Steak', 380, 'https://via.placeholder.com/300x200/2196F3/FFFFFF?text=Tuna+Steak')" class="btn btn-primary">Add to Cart</button>
                            <button onclick="openOrderModal(2, 'Tuna Steak', 380, 'https://via.placeholder.com/300x200/2196F3/FFFFFF?text=Tuna+Steak', 15)" class="btn btn-order">Order Now</button>
                        </div>
                    </div>
                </div>

                <div class="product-card">
                    <img src="https://via.placeholder.com/300x200/FF9800/FFFFFF?text=Red+Snapper" alt="Red Snapper" class="product-image">
                    <div class="product-info">
                        <h3 class="product-name">Red Snapper</h3>
                        <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 0.5rem;">Fresh Catch</p>
                        <p class="product-price">₱320/kg</p>
                        <p class="product-stock low">Only 3kg left</p>
                        <div class="product-buttons">
                            <a href="#" class="btn btn-secondary">View Details</a>
                            <button onclick="lsAddToCart(3, 'Red Snapper', 320, 'https://via.placeholder.com/300x200/FF9800/FFFFFF?text=Red+Snapper')" class="btn btn-primary">Add to Cart</button>
                            <button onclick="openOrderModal(3, 'Red Snapper', 320, 'https://via.placeholder.com/300x200/FF9800/FFFFFF?text=Red+Snapper', 3)" class="btn btn-order">Order Now</button>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 2rem; padding: 1rem; background: var(--light-gray); border-radius: 8px;">
                <h3>Test Instructions:</h3>
                <ol>
                    <li><strong>Test Order Now:</strong> Click "Order Now" on any fish to open the modal</li>
                    <li><strong>Test Quantity:</strong> Use +/- buttons or type quantity directly</li>
                    <li><strong>Test Payment:</strong> Select GCash or COD payment method</li>
                    <li><strong>Test Address:</strong> Click "Edit Address" to add/edit delivery address</li>
                    <li><strong>Test Delivery Validation:</strong> Try addresses in Naval, Almeria, Biliran (valid) vs other areas (invalid)</li>
                    <li><strong>Test Notifications:</strong> Watch for success/error/warning notifications</li>
                    <li><strong>Test Place Order:</strong> Complete all fields and click "Place Order"</li>
                </ol>
                
                <h4>Sample Valid Addresses:</h4>
                <ul>
                    <li>Municipality: Naval, Barangay: Any</li>
                    <li>Municipality: Almeria, Barangay: Any</li>
                    <li>Municipality: Biliran, Barangay: Any</li>
                </ul>
                
                <h4>Sample Invalid Addresses:</h4>
                <ul>
                    <li>Municipality: Manila, Barangay: Any</li>
                    <li>Municipality: Cebu, Barangay: Any</li>
                </ul>
            </div>
        </div>
    </main>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Order Modal -->
    <div id="order-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Order Now</h2>
                <button class="modal-close" onclick="closeOrderModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="order-item" class="order-item">
                    <img id="order-item-image" src="" alt="" class="order-item-image">
                    <div class="order-item-details">
                        <h3 id="order-item-name" class="order-item-name"></h3>
                        <p id="order-item-price" class="order-item-price"></p>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="decreaseQuantity()">-</button>
                            <input type="number" id="quantity-input" class="quantity-input" value="1" min="0.1" step="0.1" onchange="updateTotal()">
                            <button class="quantity-btn" onclick="increaseQuantity()">+</button>
                            <span style="margin-left: 0.5rem; color: var(--muted);">kg</span>
                        </div>
                    </div>
                </div>
                
                <div id="total-price" class="total-price">Total: ₱0.00</div>
                
                <div class="payment-methods">
                    <h4 style="margin-bottom: 1rem; color: var(--dark-gray);">Payment Method</h4>
                    <div class="payment-method" onclick="selectPaymentMethod('gcash')">
                        <input type="radio" name="payment" value="gcash" id="gcash">
                        <label for="gcash">GCash</label>
                    </div>
                    <div class="payment-method" onclick="selectPaymentMethod('cod')">
                        <input type="radio" name="payment" value="cod" id="cod">
                        <label for="cod">Cash on Delivery (COD)</label>
                    </div>
                </div>
                
                <div class="address-section">
                    <h4 style="margin-bottom: 1rem; color: var(--dark-gray);">Delivery Address</h4>
                    <div id="address-display" class="address-display">
                        <p id="current-address">No address set. Please add your delivery address.</p>
                        <button class="address-edit-btn" onclick="toggleAddressForm()">Edit Address</button>
                    </div>
                    <div id="address-form" class="address-form">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <input type="text" id="municipality" placeholder="Municipality" class="form-input">
                            <input type="text" id="barangay" placeholder="Barangay" class="form-input">
                        </div>
                        <textarea id="address-details" placeholder="Street address, house number, landmarks..." class="form-input" style="height: 80px; resize: vertical;"></textarea>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="saveAddress()">Save Address</button>
                            <button class="btn btn-secondary" onclick="toggleAddressForm()">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <div id="delivery-warning" class="delivery-warning" style="display: none;">
                    <strong>⚠️ Delivery Not Available</strong><br>
                    Sorry, delivery is not available in your area. You may message the seller for more information.
                </div>
            </div>
            <div class="modal-footer">
                <button id="place-order-btn" class="place-order-btn" onclick="placeOrder()" disabled>Place Order</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables for order modal
        let currentOrderItem = null;
        let currentQuantity = 1;
        let currentPrice = 0;
        let selectedPaymentMethod = null;
        let maxStock = 0;

        // Deliverable areas - CONFIGURABLE BY SELLER
        const DELIVERABLE_AREAS = ['Naval', 'Almeria', 'Biliran'];

        // Notification system
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Auto remove after 2 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 200);
        }

        // Order modal functions
        function openOrderModal(id, name, price, image, stock) {
            currentOrderItem = { id, name, price, image };
            currentPrice = parseFloat(price);
            maxStock = parseFloat(stock);
            currentQuantity = 1;
            
            // Update modal content
            document.getElementById('order-item-image').src = image;
            document.getElementById('order-item-image').alt = name;
            document.getElementById('order-item-name').textContent = name;
            document.getElementById('order-item-price').textContent = `₱${price}/kg`;
            document.getElementById('quantity-input').value = 1;
            document.getElementById('quantity-input').max = stock;
            
            // Reset form
            document.querySelectorAll('input[name="payment"]').forEach(radio => radio.checked = false);
            selectedPaymentMethod = null;
            updatePlaceOrderButton();
            
            // Load saved address
            loadSavedAddress();
            
            // Show modal
            document.getElementById('order-modal').style.display = 'flex';
            updateTotal();
        }

        function closeOrderModal() {
            document.getElementById('order-modal').style.display = 'none';
        }

        function increaseQuantity() {
            const input = document.getElementById('quantity-input');
            const current = parseFloat(input.value) || 0;
            if (current < maxStock) {
                input.value = Math.min(current + 0.1, maxStock).toFixed(1);
                updateTotal();
            }
        }

        function decreaseQuantity() {
            const input = document.getElementById('quantity-input');
            const current = parseFloat(input.value) || 0;
            if (current > 0.1) {
                input.value = Math.max(current - 0.1, 0.1).toFixed(1);
                updateTotal();
            }
        }

        function updateTotal() {
            const quantity = parseFloat(document.getElementById('quantity-input').value) || 0;
            const total = quantity * currentPrice;
            document.getElementById('total-price').textContent = `Total: ₱${total.toFixed(2)}`;
            currentQuantity = quantity;
            updatePlaceOrderButton();
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            updatePlaceOrderButton();
        }

        function updatePlaceOrderButton() {
            const hasAddress = document.getElementById('current-address').textContent !== 'No address set. Please add your delivery address.';
            const button = document.getElementById('place-order-btn');
            
            if (selectedPaymentMethod && hasAddress && currentQuantity > 0) {
                button.disabled = false;
            } else {
                button.disabled = true;
            }
        }

        // Address management
        function loadSavedAddress() {
            const savedAddress = localStorage.getItem('userAddress');
            if (savedAddress) {
                const address = JSON.parse(savedAddress);
                const addressText = `${address.municipality}, ${address.barangay}${address.details ? ', ' + address.details : ''}`;
                document.getElementById('current-address').textContent = addressText;
                checkDeliveryAvailability(address.municipality);
            } else {
                document.getElementById('current-address').textContent = 'No address set. Please add your delivery address.';
                document.getElementById('delivery-warning').style.display = 'none';
            }
            updatePlaceOrderButton();
        }

        function toggleAddressForm() {
            const form = document.getElementById('address-form');
            form.classList.toggle('show');
            
            if (form.classList.contains('show')) {
                // Load current address into form
                const savedAddress = localStorage.getItem('userAddress');
                if (savedAddress) {
                    const address = JSON.parse(savedAddress);
                    document.getElementById('municipality').value = address.municipality || '';
                    document.getElementById('barangay').value = address.barangay || '';
                    document.getElementById('address-details').value = address.details || '';
                }
            }
        }

        function saveAddress() {
            const municipality = document.getElementById('municipality').value.trim();
            const barangay = document.getElementById('barangay').value.trim();
            const details = document.getElementById('address-details').value.trim();
            
            if (!municipality || !barangay) {
                showNotification('Please fill in municipality and barangay', 'error');
                return;
            }
            
            const address = { municipality, barangay, details };
            localStorage.setItem('userAddress', JSON.stringify(address));
            
            const addressText = `${municipality}, ${barangay}${details ? ', ' + details : ''}`;
            document.getElementById('current-address').textContent = addressText;
            
            checkDeliveryAvailability(municipality);
            toggleAddressForm();
            showNotification('Address saved successfully!', 'success');
        }

        function checkDeliveryAvailability(municipality) {
            const warning = document.getElementById('delivery-warning');
            const isDeliverable = DELIVERABLE_AREAS.some(area => 
                municipality.toLowerCase().includes(area.toLowerCase())
            );
            
            if (!isDeliverable) {
                warning.style.display = 'block';
                document.getElementById('place-order-btn').disabled = true;
            } else {
                warning.style.display = 'none';
                updatePlaceOrderButton();
            }
        }

        function placeOrder() {
            if (!currentOrderItem || !selectedPaymentMethod || currentQuantity <= 0) {
                showNotification('Please complete all order details', 'error');
                return;
            }
            
            const savedAddress = localStorage.getItem('userAddress');
            if (!savedAddress) {
                showNotification('Please set your delivery address', 'error');
                return;
            }
            
            const address = JSON.parse(savedAddress);
            const isDeliverable = DELIVERABLE_AREAS.some(area => 
                address.municipality.toLowerCase().includes(area.toLowerCase())
            );
            
            if (!isDeliverable) {
                showNotification('Delivery is not available in your area', 'error');
                return;
            }
            
            // Create order object
            const order = {
                id: Date.now(),
                fish: currentOrderItem,
                quantity: currentQuantity,
                totalPrice: currentQuantity * currentPrice,
                paymentMethod: selectedPaymentMethod,
                address: address,
                timestamp: new Date().toISOString()
            };
            
            // Save order to localStorage (in a real app, this would be sent to backend)
            const orders = JSON.parse(localStorage.getItem('userOrders') || '[]');
            orders.push(order);
            localStorage.setItem('userOrders', JSON.stringify(orders));
            
            // Show success notification
            showNotification('Your order has been successfully placed. Please wait while we prepare your order.', 'success');
            
            // Close modal
            closeOrderModal();
            
            // Update stock (simulate)
            // In a real app, this would be handled by the backend
            console.log('Order placed:', order);
        }

        // Cart functions
        function getCart(){ return JSON.parse(localStorage.getItem('cartItems') || '[]'); }
        function saveCart(items){ localStorage.setItem('cartItems', JSON.stringify(items)); }
        function lsAddToCart(id, name, price, image){
            const qty = prompt('Enter quantity in kg:', '1');
            const q = Number(qty);
            if (!q || q <= 0) return;
            const items = getCart();
            const idx = items.findIndex(i => i.id === id);
            if (idx >= 0) items[idx].quantity = Number((Number(items[idx].quantity) + q).toFixed(2));
            else items.push({ id, name, price: Number(price), image, quantity: Number(q.toFixed(2)) });
            saveCart(items);
            showNotification(`${name} added to cart!`, 'success');
            updateCartCount();
        }

        function updateCartCount() {
            const cart = getCart();
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = count;
        }

        // Initialize cart count on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateCartCount();
        });

        // Close modal when clicking outside
        document.getElementById('order-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeOrderModal();
            }
        });
    </script>
</body>
</html>
